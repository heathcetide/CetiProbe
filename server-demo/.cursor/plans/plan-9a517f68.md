<!-- 2b7b6716-5e9d-43b8-8369-7c487cae9d42 3f46ce61-7dad-4739-ba03-6f5db162613a -->
# CA证书自动导入功能实现计划

## 概述
实现跨平台的CA证书自动导入功能，点击下载按钮后自动导入证书到系统信任区，如果自动导入失败则弹出手动导入指引。

## 实现步骤

### 1. 后端API增强

**修改文件**: `cmd/main.go`

在代理相关API部分（第176-203行附近）增加新的端点：

```go
// 新增：自动安装证书端点
api.POST("/proxy/ca/install", func(c *gin.Context) {
    os := c.Query("os") // darwin/windows/linux
    _, _, files, err := pxy.LoadCAFromDisk()
    if err != nil {
        _, _, files, err = pxy.GenerateCA()
        if err != nil {
            c.JSON(500, gin.H{"error": err.Error()})
            return
        }
    }
    
    // 根据操作系统返回安装脚本或执行命令
    script, instructions := generateInstallScript(os, files.CertPath)
    c.JSON(200, gin.H{
        "script": script,
        "instructions": instructions,
        "cert_path": files.CertPath,
    })
})

// 新增：获取证书安装指引
api.GET("/proxy/ca/instructions", func(c *gin.Context) {
    os := c.Query("os")
    instructions := getCertInstallInstructions(os)
    c.JSON(200, gin.H{"instructions": instructions})
})
```

### 2. 创建证书安装辅助模块

**新建文件**: `internal/proxy/cert_installer.go`

```go
package proxy

import (
    "fmt"
    "os/exec"
    "runtime"
)

// InstallCert 尝试自动安装证书到系统信任区
func InstallCert(certPath string) error {
    switch runtime.GOOS {
    case "darwin":
        return installCertMac(certPath)
    case "windows":
        return installCertWindows(certPath)
    case "linux":
        return installCertLinux(certPath)
    default:
        return fmt.Errorf("unsupported platform: %s", runtime.GOOS)
    }
}

// installCertMac macOS使用security命令安装
func installCertMac(certPath string) error {
    cmd := exec.Command("security", "add-trusted-cert", 
        "-d", "-r", "trustRoot", 
        "-k", "/Library/Keychains/System.keychain", 
        certPath)
    return cmd.Run()
}

// installCertWindows Windows使用certutil安装
func installCertWindows(certPath string) error {
    cmd := exec.Command("certutil", "-addstore", "-f", "ROOT", certPath)
    return cmd.Run()
}

// installCertLinux Linux复制到系统证书目录并更新
func installCertLinux(certPath string) error {
    // Ubuntu/Debian
    cmd := exec.Command("sh", "-c", 
        fmt.Sprintf("cp %s /usr/local/share/ca-certificates/probe-ca.crt && update-ca-certificates", certPath))
    err := cmd.Run()
    if err == nil {
        return nil
    }
    
    // CentOS/RHEL
    cmd = exec.Command("sh", "-c",
        fmt.Sprintf("cp %s /etc/pki/ca-trust/source/anchors/probe-ca.crt && update-ca-trust", certPath))
    return cmd.Run()
}

// GetInstallInstructions 获取各平台手动安装指引
func GetInstallInstructions(osType string) map[string]interface{} {
    instructions := map[string]map[string]interface{}{
        "darwin": {
            "title": "macOS 手动安装步骤",
            "steps": []string{
                "1. 双击下载的 proxy_root_ca.pem 文件",
                "2. 在弹出的钥匙串访问中，选择"系统"钥匙串",
                "3. 找到 CetiProbe Root CA 证书，双击打开",
                "4. 展开"信任"部分，将"使用此证书时"设置为"始终信任"",
                "5. 关闭窗口，输入系统密码确认",
            },
            "command": "sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain proxy_root_ca.pem",
        },
        "windows": {
            "title": "Windows 手动安装步骤",
            "steps": []string{
                "1. 右键点击下载的证书文件，选择"安装证书"",
                "2. 选择"本地计算机"，点击下一步",
                "3. 选择"将所有证书都放入下列存储"",
                "4. 点击"浏览"，选择"受信任的根证书颁发机构"",
                "5. 点击完成，在安全警告中选择"是"",
            },
            "command": "certutil -addstore -f ROOT proxy_root_ca.pem",
        },
        "linux": {
            "title": "Linux 手动安装步骤",
            "steps": []string{
                "Ubuntu/Debian:",
                "  sudo cp proxy_root_ca.pem /usr/local/share/ca-certificates/probe-ca.crt",
                "  sudo update-ca-certificates",
                "",
                "CentOS/RHEL:",
                "  sudo cp proxy_root_ca.pem /etc/pki/ca-trust/source/anchors/probe-ca.crt",
                "  sudo update-ca-trust",
            },
            "command": "",
        },
    }
    
    if inst, ok := instructions[osType]; ok {
        return inst
    }
    return instructions["darwin"]
}
```

### 3. 前端界面更新

**修改文件**: `web/index.html`

修改第38行的下载链接为按钮，并添加弹窗模态框：

```html
<!-- 替换原来的下载链接 -->
<button id="downloadCertBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">下载并安装证书</button>
<button id="manualInstallBtn" class="px-3 py-1 bg-gray-500 text-white rounded text-xs">手动安装指引</button>

<!-- 在</body>之前添加模态框 -->
<div id="certModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold" id="modalTitle">证书安装指引</h2>
      <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    <div id="modalContent" class="text-sm space-y-2"></div>
    <div class="mt-4 p-3 bg-gray-100 rounded">
      <div class="text-xs text-gray-600 mb-1">命令行安装（需要管理员权限）：</div>
      <code id="installCommand" class="block text-xs bg-white p-2 rounded border select-all"></code>
      <button id="copyCommand" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded text-xs">复制命令</button>
    </div>
  </div>
</div>
```

在JavaScript部分（第72行之后）添加事件处理：

```javascript
// 检测操作系统
function detectOS() {
  const ua = navigator.userAgent.toLowerCase();
  if (ua.indexOf('mac') !== -1) return 'darwin';
  if (ua.indexOf('win') !== -1) return 'windows';
  if (ua.indexOf('linux') !== -1) return 'linux';
  return 'darwin';
}

// 下载并尝试自动安装证书
el('downloadCertBtn').addEventListener('click', async () => {
  const os = detectOS();
  try {
    // 先下载证书文件
    const link = document.createElement('a');
    link.href = '/api/proxy/ca';
    link.download = 'proxy_root_ca.pem';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // 等待下载完成后尝试获取安装指引
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // 显示安装指引
    const resp = await apiGet('/api/proxy/ca/instructions?os=' + os);
    showInstallModal(resp.instructions, os);
    
    // 提示用户
    alert('证书已下载！\n\nmacOS用户：如果浏览器允许，可以尝试运行终端命令自动安装。\n否则请按照弹出窗口中的步骤手动安装。');
  } catch (e) {
    alert('下载失败: ' + e.message);
  }
});

// 显示手动安装指引
el('manualInstallBtn').addEventListener('click', async () => {
  const os = detectOS();
  try {
    const resp = await apiGet('/api/proxy/ca/instructions?os=' + os);
    showInstallModal(resp.instructions, os);
  } catch (e) {
    alert('获取安装指引失败: ' + e.message);
  }
});

// 显示模态框
function showInstallModal(instructions, os) {
  el('modalTitle').textContent = instructions.title || '证书安装指引';
  
  const content = el('modalContent');
  content.innerHTML = '';
  
  if (Array.isArray(instructions.steps)) {
    instructions.steps.forEach(step => {
      const p = document.createElement('p');
      p.textContent = step;
      p.className = 'text-gray-700';
      content.appendChild(p);
    });
  }
  
  el('installCommand').textContent = instructions.command || '请参考上方步骤手动安装';
  el('certModal').classList.remove('hidden');
}

// 关闭模态框
el('closeModal').addEventListener('click', () => {
  el('certModal').classList.add('hidden');
});

// 复制命令
el('copyCommand').addEventListener('click', () => {
  const cmd = el('installCommand').textContent;
  navigator.clipboard.writeText(cmd).then(() => {
    alert('命令已复制到剪贴板！');
  }).catch(() => {
    alert('复制失败，请手动复制');
  });
});

// 点击模态框外部关闭
el('certModal').addEventListener('click', (e) => {
  if (e.target.id === 'certModal') {
    el('certModal').classList.add('hidden');
  }
});
```

### 4. 后端辅助函数实现

在 `cmd/main.go` 中添加辅助函数（在main函数之外）：

```go
func generateInstallScript(osType, certPath string) (script string, instructions map[string]interface{}) {
    instructions = pxy.GetInstallInstructions(osType)
    
    switch osType {
    case "darwin":
        script = fmt.Sprintf("sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain %s", certPath)
    case "windows":
        script = fmt.Sprintf("certutil -addstore -f ROOT %s", certPath)
    case "linux":
        script = fmt.Sprintf("sudo cp %s /usr/local/share/ca-certificates/probe-ca.crt && sudo update-ca-certificates", certPath)
    }
    
    return script, instructions
}

func getCertInstallInstructions(osType string) map[string]interface{} {
    return pxy.GetInstallInstructions(osType)
}
```

## 测试验证

1. 启动代理服务器
2. 点击"下载并安装证书"按钮
3. 验证证书文件是否下载成功
4. 验证弹窗是否显示正确的安装指引
5. 尝试复制命令到终端执行
6. 在浏览器中访问HTTPS代理网站验证证书是否生效

## 注意事项

- macOS需要管理员权限（sudo）才能安装到系统钥匙串
- Windows需要以管理员身份运行命令提示符
- Linux不同发行版的证书路径可能不同
- 浏览器无法直接执行系统命令，需要用户手动操作
- 提供清晰的错误提示和回退方案
